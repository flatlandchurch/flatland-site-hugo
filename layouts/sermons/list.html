{{ define "main" }}
<section>
    <div class="container container__content">
        <h1>Sermons</h1>
        {{ $latest := index .Paginator.Pages.ByDate.Reverse 0 }}
        {{ if not .Paginator.HasPrev }}
        <div class="sermon-card sermon-card--featured">
            {{ with $latest }}
                <img src="{{ .Params.Image }}" />
                <p>{{ .Title }}</p>
                <p>{{ .Permalink }}</p>
            {{ end }}
        </div>
        {{ end }}
        <!-- TODO: add current series -->
        {{ if $latest.Params.Series }}
        <div class="sermon-grid--current-series">
            {{ range where .Pages "Sermons" "Params.series" $latest.Params.Series }}
            <p>{{ .Title }}</p>
            {{ end }}
        </div>
        {{ end }}

        <h2 class="sermon-section-title">
            All Sermons
        </h2>

        <div class="sermon-grid">
        {{ range after 1 .Paginator.Pages.ByDate.Reverse }}
            <div>
                <div class="sermon-card">
                    <img src="{{ .Params.Image }}" alt="Sermon thumbnail" />
                </div>
                {{ .Title }}
            </div>
        {{ end }}
        </div>
    </div>
</section>
<script>
  (() => {
    const PAGE_DATA_KEY = 'fc:pageData:sermons:lastVisit';
    const lastVisit = window.localStorage.getItem(PAGE_DATA_KEY) || '';
    {{ with index .Paginator.Pages.ByDate.Reverse 0 }}
    const latestDate = "{{ .Date.Format "2006-01-02" }}";
    {{ end }}

    if (latestDate > lastVisit) {
      const el = document.querySelector('.sermon-card--featured');
      el.className += ` sermon-card--new`;
    }

    const now = new Date();
    const pad = (num) => num.toString().padStart(2, '0');
    const saveDate = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`;
    localStorage.setItem(PAGE_DATA_KEY, saveDate);
  })();
</script>
{{ end }}
